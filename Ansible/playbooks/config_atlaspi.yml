- name: Full set up of a new AtlasPi server from brass tacks
  hosts: "atlaspi"
  become: yes
  tasks:
    # Make sure config_rpi.yml (Or manual setup) has been done first!
    # TODO: change default password here
    # Now we do the AtlasPi Specific changes
    - name: create nas mount - Media directory
      file:
        path: /mnt/nas/Media
        state: directory
        mode: '0775'
    - name: create nas mount - Public directory
      file:
        path: /mnt/nas/Public
        state: directory
        mode: '0775'
    - name: copy CREDS files
      copy:
        src: "{{ item }}"
        dest: /home/pi
        owner: pi
        group: pi
        mode: '644'
      with_fileglob: "~/Code/Unix/Pi_Files/Atlas/file_templates/.*CREDS"
    - name: Configure Transmission Public Mount
        ansible.posix.mount:
          path: /mnt/nas/Public
          src: //192.168.4.200/Public
          fstype: cifs
          opts: "credentials=/home/pi/.NASCREDS,uid=1000,gid=100,file_mode=0777,dir_mode=0777,vers=2.0"
          state: present
    - name: Configure Plex Media Mount
        ansible.posix.mount:
          path: /mnt/nas/Media
          src: //192.168.4.200/MediaContent
          fstype: cifs
          opts: "credentials=/home/pi/.PLEXCREDS,uid=1000,gid=100,file_mode=0775,dir_mode=0775,vers=2.0"
          state: present
    # TODO: install docker and images/containers
    - name: copy AtlasPi admin files
      copy:
        src: "{{ item }}"
        dest: /home/pi/bin
        owner: pi
        group: pi
        mode: '755'
      with_fileglob: "~/Code/Unix/Pi_Files/Atlas/*.sh"
    - name: Configure transmission data cleanup
      ansible.builtin.cron:
        name: "configure bt_cleanup.sh"
        user: pi
        minute: "0"
        hour: "8"
        job: "/home/pi/bin/bt_cleanup.sh>/home/pi/log/btclean.log 2>&1"
    - name: Configure CalibreWeb container bounce
      ansible.builtin.cron:
        name: "configure container_restart.sh"
        user: pi
        minute: "0"
        hour: "3"
        job: "/home/pi/bin/container_restart.sh>/home/pi/log/container-bounce.log 2>&1"
    - name: Configure File movement script
      ansible.builtin.cron:
        name: "configure media_copy.sh"
        user: pi
        minute: "*/20"
        job: "/home/pi/bin/media_copy.sh>/home/pi/log/media-move.log 2>&1"
    # Final Steps go here: Change the hostnames and reboot the system.
    - name: Set a hostname specifying strategy
      ansible.builtin.hostname:
        name: AtlasPi
        use: debian