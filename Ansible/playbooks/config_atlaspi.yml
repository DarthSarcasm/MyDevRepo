- name: Full set up of a new AtlasPi server from brass tacks
  hosts: "{{ variable_host }}"
  become: yes
  tasks:
    - name: basic os upgrade
      apt:
        update_cache: yes
        upgrade: 'yes'
    - name: install required packages
      apt:
        name:
          - zsh
          - wget
          - git
        state: present
        update_cache: true
    - name: create bin directory
      file:
        path: /home/pi/bin
        state: directory
        mode: '0644'
    - name: create log directory
      file:
        path: /home/pi/log
        state: directory
        mode: '0644'
    - name: copy server admin files
      copy:
        src: "{{ item }}"
        dest: /home/pi/bin
        owner: pi
        group: pi
        mode: '755'
      with_fileglob: "~/Code/Unix/Pi_Files/General/server_*"
    - name: change user shell to zsh
      user:
        name: pi
        shell: /usr/bin/zsh
    - name: copy zsh config
      copy:
        src: "{{ item }}"
        dest: /home/pi
        owner: pi
        group: pi
        mode: '644'
      with_fileglob: "~/Code/Unix/Pi_Files/General/config/.z*"
    - name: Create the auto update schedule
      ansible.builtin.cron:
        name: "configure server_update.sh"
        user: pi
        weekday: "6"
        minute: "0"
        hour: "6"
        job: "/home/pi/bin/server_update.sh>/home/pi/log/update.log 2>&1"
    - name: create nas mount - Media directory
      file:
        path: /mnt/nas/Media
        state: directory
        mode: '0775'
    - name: create nas mount - Public directory
      file:
        path: /mnt/nas/Public
        state: directory
        mode: '0775'
    - name: copy CREDS files
      copy:
        src: "{{ item }}"
        dest: /home/pi
        owner: pi
        group: pi
        mode: '644'
      with_fileglob: "~/Code/Unix/Pi_Files/Atlas/file_templates/.*CREDS"
    - name: Configure Transmission Public Mount
        ansible.posix.mount:
          path: /mnt/nas/Public
          src: //192.168.4.200/Public
          fstype: cifs
          opts: "credentials=/home/pi/.NASCREDS,uid=1000,gid=100,file_mode=0777,dir_mode=0777,vers=2.0"
          state: present
    - name: Configure Plex Media Mount
        ansible.posix.mount:
          path: /mnt/nas/Media
          src: //192.168.4.200/MediaContent
          fstype: cifs
          opts: "credentials=/home/pi/.PLEXCREDS,uid=1000,gid=100,file_mode=0775,dir_mode=0775,vers=2.0"
          state: present